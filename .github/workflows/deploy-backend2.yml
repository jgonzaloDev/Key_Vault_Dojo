name: Deploy Backend  (Spring Boot Multimodulo 2026)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - develop

permissions:
  id-token: write
  contents: read

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      # =============================
      # 1Ô∏è‚É£ Login en Azure mediante OIDC
      # =============================
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # =============================
      # 2Ô∏è‚É£ Clonar el backend Spring Boot desde su repositorio
      # =============================
      - name: Clonar backend (Spring Boot)
        uses: actions/checkout@v4
        with:
          repository: jgonzaloDev/MULTIMODULO-MONOLITO-2026
          ref: main
          token: ${{ secrets.GH_PERSONAL_TOKEN }}
          path: backend

      # =============================
      # 3Ô∏è‚É£ Configurar Java 17 y Maven
      # =============================
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # =============================
      # 4Ô∏è‚É£ Compilar el proyecto Spring Boot multimodulo
      # =============================
      - name: Build with Maven
        working-directory: ./backend
        run: |
          echo "üî® Compilando proyecto Spring Boot multimodulo..."
          mvn clean package -DskipTests
          
          echo "‚úÖ Build completado"
          echo "üì¶ Listando JARs generados:"
          find . -name "*.jar" -type f

      # =============================
      # 5Ô∏è‚É£ Identificar el JAR principal (multimodulo)
      # =============================
      - name: Identify Main JAR
        id: jar
        working-directory: ./backend
        run: |
          echo "üîç Buscando JAR ejecutable en proyecto multimodulo..."
          
          MAIN_JAR=$(find . -path "*/target/*.jar" \
            ! -name "*-original.jar" \
            ! -name "*-sources.jar" \
            ! -name "*-javadoc.jar" \
            -type f \
            -exec sh -c 'jar -tf {} | grep -q "org/springframework/boot/loader/JarLauncher" && echo {}' \; \
            | head -n 1)
          
          if [ -z "$MAIN_JAR" ]; then
            echo "‚ö†Ô∏è  No se encontr√≥ JAR con JarLauncher, buscando JAR m√°s grande..."
            MAIN_JAR=$(find . -path "*/target/*.jar" \
              ! -name "*-original.jar" \
              ! -name "*-sources.jar" \
              ! -name "*-javadoc.jar" \
              -type f \
              -exec ls -lh {} \; | sort -k5 -hr | head -n 1 | awk '{print $9}')
          fi
          
          if [ -z "$MAIN_JAR" ]; then
            echo "‚ùå No se encontr√≥ ning√∫n JAR ejecutable"
            echo "üì¶ JARs disponibles:"
            find . -name "*.jar" -type f
            exit 1
          fi
          
          echo "JAR_FILE=$MAIN_JAR" >> $GITHUB_OUTPUT
          echo "‚úÖ JAR ejecutable identificado: $MAIN_JAR"
          ls -lh "$MAIN_JAR"

      # =============================
      # 6Ô∏è‚É£ Desplegar en Azure App Service
      # =============================
      - name: Deploy Spring Boot to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.TF_VAR_WEBAPP_BACKEND_NAME }}
          package: ./backend/${{ steps.jar.outputs.JAR_FILE }}

      # =============================
      # 7Ô∏è‚É£ Verificar deployment
      # =============================
      - name: Verify Deployment
        run: |
          echo "üîç Verificando deployment..."
          
          APP_URL="https://${{ secrets.TF_VAR_WEBAPP_BACKEND_NAME }}.azurewebsites.net"
          
          echo "üìç URL de la aplicaci√≥n: $APP_URL"
          echo "üè• Health check: $APP_URL/actuator/health"
          
          echo "‚è≥ Esperando 30 segundos para que la app inicie..."
          sleep 30
          
          if curl -f -s "$APP_URL/actuator/health" > /dev/null 2>&1; then
            echo "‚úÖ Backend desplegado exitosamente y respondiendo"
          else
            echo "‚ö†Ô∏è  Backend desplegado pero health check fall√≥ (puede tardar unos minutos en estar listo)"
          fi

      # =============================
      # 8Ô∏è‚É£ Logout de Azure
      # =============================
      - name: Azure Logout
        if: always()
        run: az logout || true
