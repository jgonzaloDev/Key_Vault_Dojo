#cloud-config

# Script de inicializaci√≥n para VM con:
# - Escritorio gr√°fico XFCE4
# - XRDP para acceso remoto
# - Docker + Docker Compose
# - OTel Collector (gRPC puerto 4317)
# - Elasticsearch (puerto 9200)
# - Kibana (puerto 5601)

package_update: true
package_upgrade: true

packages:
  # Escritorio gr√°fico XFCE completo
  - xfce4
  - xfce4-goodies
  - xfce4-terminal
  - xrdp
  - dbus-x11
  - xorg
  - xserver-xorg-core
  - xserver-xorg-input-all
  # Navegadores y herramientas
  - firefox
  - chromium-browser
  # Docker dependencies
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  # Utilidades
  - git
  - vim
  - wget
  - unzip
  - net-tools
  - htop

runcmd:
  # ============================================
  # Configurar XRDP para usar XFCE
  # ============================================
  - echo "xfce4-session" > /home/${admin_username}/.xsession
  - chown ${admin_username}:${admin_username} /home/${admin_username}/.xsession
  
  # Configurar startxfce4 para el usuario
  - echo "#!/bin/bash" > /home/${admin_username}/.xsessionrc
  - echo "export XDG_SESSION_DESKTOP=xfce" >> /home/${admin_username}/.xsessionrc
  - echo "export XDG_DATA_DIRS=/usr/share/xfce4:/usr/local/share:/usr/share:/var/lib/snapd/desktop" >> /home/${admin_username}/.xsessionrc
  - echo "export XDG_CONFIG_DIRS=/etc/xdg/xfce4:/etc/xdg" >> /home/${admin_username}/.xsessionrc
  - chown ${admin_username}:${admin_username} /home/${admin_username}/.xsessionrc
  - chmod +x /home/${admin_username}/.xsessionrc
  
  # Configurar XRDP
  - sed -i 's/3389/3389/g' /etc/xrdp/xrdp.ini
  - sed -i 's/max_bpp=32/max_bpp=128/g' /etc/xrdp/xrdp.ini
  - sed -i 's/xserverbpp=24/xserverbpp=128/g' /etc/xrdp/xrdp.ini
  
  # Configurar startwm.sh para XFCE
  - |
    cat > /etc/xrdp/startwm.sh <<'XRDPEOF'
    #!/bin/sh
    if [ -r /etc/default/locale ]; then
      . /etc/default/locale
      export LANG LANGUAGE
    fi
    export XDG_SESSION_DESKTOP=xfce
    export XDG_DATA_DIRS=/usr/share/xfce4:/usr/local/share:/usr/share:/var/lib/snapd/desktop
    export XDG_CONFIG_DIRS=/etc/xdg/xfce4:/etc/xdg
    startxfce4
    XRDPEOF
  
  - chmod +x /etc/xrdp/startwm.sh
  
  # Configurar pol√≠ticas de color para XFCE
  - |
    cat > /etc/polkit-1/localauthority/50-local.d/45-allow-colord.pkla <<'EOF'
    [Allow Colord all Users]
    Identity=unix-user:*
    Action=org.freedesktop.color-manager.create-device;org.freedesktop.color-manager.create-profile;org.freedesktop.color-manager.delete-device;org.freedesktop.color-manager.delete-profile;org.freedesktop.color-manager.modify-device;org.freedesktop.color-manager.modify-profile
    ResultAny=no
    ResultInactive=no
    ResultActive=yes
    EOF
  
  # Reiniciar servicio XRDP
  - systemctl enable xrdp
  - systemctl restart xrdp
  
  # Asegurar que el usuario est√© en los grupos necesarios
  - usermod -aG ssl-cert ${admin_username}
  
  # ============================================
  # Instalar Docker
  # ============================================
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
  
  # Agregar usuario al grupo docker
  - usermod -aG docker ${admin_username}
  
  # Habilitar Docker al inicio
  - systemctl enable docker
  - systemctl start docker
  
  # ============================================
  # Crear directorios para Docker Compose
  # ============================================
  - mkdir -p /home/${admin_username}/otel-stack
  - mkdir -p /home/${admin_username}/otel-stack/otel-collector-config
  - mkdir -p /home/${admin_username}/otel-stack/elasticsearch-data
  - mkdir -p /home/${admin_username}/otel-stack/kibana-data
  
  # ============================================
  # Crear configuraci√≥n de OTel Collector
  # ============================================
  - |
    cat > /home/${admin_username}/otel-stack/otel-collector-config/otel-collector-config.yaml <<'EOF'
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

    processors:
      batch:
        timeout: 10s
        send_batch_size: 1024

    exporters:
      otlphttp/apm:
        endpoint: http://apm-server:8200
      elasticsearch:
        endpoints:
          - http://elasticsearch:9200
        traces_index: otel-traces
        logs_index: otel-logs
        metrics_index: otel-metrics
        tls:
          insecure: true
      debug:
        verbosity: detailed

    service:
      pipelines:
        traces:
          receivers:
            - otlp
          processors:
            - batch
          exporters:
            - otlphttp/apm
            - elasticsearch
            - debug
        metrics:
          receivers:
            - otlp
          processors:
            - batch
          exporters:
            - elasticsearch
            - debug
        logs:
          receivers:
            - otlp
          processors:
            - batch
          exporters:
            - elasticsearch
            - debug
    EOF
  
  # ============================================
  # Crear docker-compose.yaml para OTel Collector
  # ============================================
  - |
    cat > /home/${admin_username}/otel-stack/docker-compose-collector.yaml <<'EOF'
    version: '3.8'

    services:
      otel-collector:
        image: otel/opentelemetry-collector-contrib:latest
        container_name: otel-collector
        command: ["--config=/etc/otel-collector-config.yaml"]
        volumes:
          - ./otel-collector-config/otel-collector-config.yaml:/etc/otel-collector-config.yaml
        ports:
          - "4317:4317"   # gRPC
          - "4318:4318"   # HTTP
        networks:
          - otel-network
        restart: unless-stopped

    networks:
      otel-network:
        driver: bridge
    EOF
  
  # ============================================
  # Crear docker-compose.yaml para Elasticsearch + Kibana + APM Server
  # ============================================
  - |
    cat > /home/${admin_username}/otel-stack/docker-compose-elastic.yaml <<'EOF'
    version: '3.8'

    services:
      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
        container_name: elasticsearch
        environment:
          - discovery.type=single-node
          - xpack.security.enabled=false
          - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
        volumes:
          - ./elasticsearch-data:/usr/share/elasticsearch/data
        ports:
          - "9200:9200"
          - "9300:9300"
        networks:
          - otel-network
        restart: unless-stopped
        healthcheck:
          test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
          interval: 30s
          timeout: 10s
          retries: 5

      apm-server:
        image: docker.elastic.co/apm/apm-server:8.11.0
        container_name: apm-server
        environment:
          - output.elasticsearch.hosts=["http://elasticsearch:9200"]
          - apm-server.host=0.0.0.0:8200
          - apm-server.rum.enabled=true
          - setup.kibana.host=http://kibana:5601
          - setup.template.enabled=true
          - logging.to_files=false
        ports:
          - "8200:8200"
        networks:
          - otel-network
        depends_on:
          elasticsearch:
            condition: service_healthy
        restart: unless-stopped
        healthcheck:
          test: ["CMD-SHELL", "curl -f http://localhost:8200/ || exit 1"]
          interval: 30s
          timeout: 10s
          retries: 5

      kibana:
        image: docker.elastic.co/kibana/kibana:8.11.0
        container_name: kibana
        environment:
          - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
          - xpack.apm.enabled=true
          - xpack.apm.ui.enabled=true
        ports:
          - "5601:5601"
        networks:
          - otel-network
        depends_on:
          apm-server:
            condition: service_healthy
        restart: unless-stopped

    networks:
      otel-network:
        driver: bridge
    EOF
  
  # ============================================
  # Crear script de inicio
  # ============================================
  - |
    cat > /home/${admin_username}/otel-stack/start-all.sh <<'EOF'
    #!/bin/bash
    echo "üöÄ Iniciando stack de observabilidad..."
    
    # Iniciar Elasticsearch, APM Server y Kibana
    echo "üìä Iniciando Elasticsearch, APM Server y Kibana..."
    docker compose -f docker-compose-elastic.yaml up -d
    
    # Esperar a que Elasticsearch y APM Server est√©n listos
    echo "‚è≥ Esperando a que Elasticsearch y APM Server est√©n listos..."
    sleep 45
    
    # Iniciar OTel Collector
    echo "üì° Iniciando OTel Collector..."
    docker compose -f docker-compose-collector.yaml up -d
    
    echo "‚úÖ Stack iniciado correctamente!"
    echo ""
    echo "Servicios disponibles:"
    echo "  - OTel Collector (gRPC): 4317"
    echo "  - OTel Collector (HTTP): 4318"
    echo "  - APM Server: 8200"
    echo "  - Elasticsearch: 9200"
    echo "  - Kibana: 5601"
    echo ""
    echo "Ver logs:"
    echo "  docker compose -f docker-compose-elastic.yaml logs -f"
    echo "  docker compose -f docker-compose-collector.yaml logs -f"
    EOF
  
  - chmod +x /home/${admin_username}/otel-stack/start-all.sh
  
  # ============================================
  # Crear script de detenci√≥n
  # ============================================
  - |
    cat > /home/${admin_username}/otel-stack/stop-all.sh <<'EOF'
    #!/bin/bash
    echo "üõë Deteniendo stack de observabilidad..."
    docker compose -f docker-compose-collector.yaml down
    docker compose -f docker-compose-elastic.yaml down
    echo "‚úÖ Stack detenido"
    EOF
  
  - chmod +x /home/${admin_username}/otel-stack/stop-all.sh
  
  # ============================================
  # Crear acceso directo de Kibana en el escritorio
  # ============================================
  - |
    cat > /usr/share/applications/kibana.desktop <<EOF
    [Desktop Entry]
    Name=Kibana Dashboard
    GenericName=Observability Dashboard
    Comment=Open Kibana in Firefox
    Exec=firefox http://localhost:5601
    Terminal=false
    Type=Application
    Icon=firefox
    Categories=Development;Network;
    EOF
  
  # Copiar acceso directo al escritorio del usuario
  - mkdir -p /home/${admin_username}/Desktop
  - cp /usr/share/applications/kibana.desktop /home/${admin_username}/Desktop/
  - chmod +x /home/${admin_username}/Desktop/kibana.desktop
  
  # ============================================
  # Crear acceso directo de Firefox en el escritorio
  # ============================================
  - |
    cat > /home/${admin_username}/Desktop/firefox.desktop <<EOF
    [Desktop Entry]
    Name=Firefox Web Browser
    GenericName=Web Browser
    Comment=Browse the World Wide Web
    Exec=firefox %u
    Terminal=false
    Type=Application
    Icon=firefox
    Categories=Network;WebBrowser;
    MimeType=text/html;text/xml;application/xhtml+xml;
    StartupNotify=true
    EOF
  
  - chmod +x /home/${admin_username}/Desktop/firefox.desktop
  
  # ============================================
  # Crear acceso directo para Docker Logs
  # ============================================
  - |
    cat > /home/${admin_username}/Desktop/docker-logs.desktop <<EOF
    [Desktop Entry]
    Name=Docker Logs
    GenericName=View Docker Logs
    Comment=Open terminal with docker logs
    Exec=xfce4-terminal -e "bash -c 'cd ~/otel-stack && docker compose -f docker-compose-elastic.yaml logs -f; exec bash'"
    Terminal=false
    Type=Application
    Icon=utilities-terminal
    Categories=System;
    EOF
  
  - chmod +x /home/${admin_username}/Desktop/docker-logs.desktop
  
  # ============================================
  # Crear acceso directo para Terminal
  # ============================================
  - |
    cat > /home/${admin_username}/Desktop/terminal.desktop <<EOF
    [Desktop Entry]
    Name=Terminal
    GenericName=Terminal Emulator
    Comment=Use the command line
    Exec=xfce4-terminal
    Terminal=false
    Type=Application
    Icon=utilities-terminal
    Categories=System;TerminalEmulator;
    EOF
  
  - chmod +x /home/${admin_username}/Desktop/terminal.desktop
  
  # ============================================
  # Ajustar permisos
  # ============================================
  - chown -R ${admin_username}:${admin_username} /home/${admin_username}/otel-stack
  - chown -R ${admin_username}:${admin_username} /home/${admin_username}/Desktop
  - chmod -R 755 /home/${admin_username}/otel-stack
  
  # ============================================
  # Crear archivo README en el escritorio
  # ============================================
  - |
    cat > /home/${admin_username}/Desktop/README.txt <<EOF
    ========================================
    VM Observability Stack - Informaci√≥n
    ========================================
    
    üñ•Ô∏è  ESCRITORIO REMOTO (RDP):
       Puerto: 3389
       Usuario: ${admin_username}
       Contrase√±a: (la que configuraste)
    
    üìÅ Directorio principal: ~/otel-stack
    
    üöÄ Iniciar todo el stack:
       cd ~/otel-stack
       ./start-all.sh
    
    üõë Detener todo el stack:
       cd ~/otel-stack
       ./stop-all.sh
    
    üìä Servicios disponibles:
       - OTel Collector (gRPC): puerto 4317
       - OTel Collector (HTTP): puerto 4318
       - APM Server: puerto 8200
       - Elasticsearch: puerto 9200
       - Kibana: puerto 5601
    
    üîç Ver logs:
       docker compose -f docker-compose-elastic.yaml logs -f
       docker compose -f docker-compose-collector.yaml logs -f
    
    üåê Acceder a Kibana:
       - Desde el escritorio: doble click en "Kibana Dashboard"
       - Desde navegador: http://localhost:5601
       - Desde fuera: http://<IP_PUBLICA>:5601
    
    üì° Endpoints para App Services:
       - OTel gRPC (interno): http://<IP_PRIVADA>:4317
       - OTel HTTP (interno): http://<IP_PRIVADA>:4318
       - APM Server (interno): http://<IP_PRIVADA>:8200
    
    üê≥ Comandos √∫tiles de Docker:
       docker ps                    # Ver contenedores
       docker compose ps            # Ver servicios
       docker logs <container>      # Ver logs de un contenedor
       docker stats                 # Ver uso de recursos
    
    üìà APM en Kibana:
       1. Abre Kibana: http://localhost:5601
       2. Ve a "Observability" ‚Üí "APM"
       3. Ver√°s las trazas de tus aplicaciones
    
    ========================================
    EOF
  
  - chown ${admin_username}:${admin_username} /home/${admin_username}/Desktop/README.txt
  
  # ============================================
  # Iniciar el stack autom√°ticamente
  # ============================================
  - cd /home/${admin_username}/otel-stack && sudo -u ${admin_username} ./start-all.sh

final_message: "VM Observability Stack con Escritorio XFCE lista! Docker, OTel Collector, Elasticsearch, Kibana y RDP configurados."
