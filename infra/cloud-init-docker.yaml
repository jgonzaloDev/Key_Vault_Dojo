#cloud-config

# Script de inicializaci√≥n para VM con:
# - Escritorio gr√°fico XFCE4
# - XRDP para acceso remoto
# - Docker + Docker Compose
# - OTel Collector (gRPC puerto 4317)
# - Elasticsearch (puerto 9200)
# - Kibana (puerto 5601)

package_update: true
package_upgrade: true

packages:
  # Escritorio gr√°fico
  - xfce4
  - xfce4-goodies
  - xrdp
  - firefox
  # Docker dependencies
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  # Utilidades
  - git
  - vim
  - wget
  - unzip

runcmd:
  # ============================================
  # Configurar XRDP para usar XFCE
  # ============================================
  - echo "xfce4-session" > /home/${admin_username}/.xsession
  - chown ${admin_username}:${admin_username} /home/${admin_username}/.xsession
  
  # Configurar XRDP
  - sed -i 's/3389/3389/g' /etc/xrdp/xrdp.ini
  - sed -i 's/max_bpp=32/max_bpp=128/g' /etc/xrdp/xrdp.ini
  - sed -i 's/xserverbpp=24/xserverbpp=128/g' /etc/xrdp/xrdp.ini
  - echo "startxfce4" > /etc/xrdp/startwm.sh
  
  # Reiniciar servicio XRDP
  - systemctl enable xrdp
  - systemctl restart xrdp
  
  # ============================================
  # Instalar Docker
  # ============================================
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
  
  # Agregar usuario al grupo docker
  - usermod -aG docker ${admin_username}
  
  # Habilitar Docker al inicio
  - systemctl enable docker
  - systemctl start docker
  
  # ============================================
  # Crear directorios para Docker Compose
  # ============================================
  - mkdir -p /home/${admin_username}/otel-stack
  - mkdir -p /home/${admin_username}/otel-stack/otel-collector-config
  - mkdir -p /home/${admin_username}/otel-stack/elasticsearch-data
  - mkdir -p /home/${admin_username}/otel-stack/kibana-data
  
  # ============================================
  # Crear configuraci√≥n de OTel Collector
  # ============================================
  - |
    cat > /home/${admin_username}/otel-stack/otel-collector-config/otel-collector-config.yaml <<'EOF'
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

    processors:
      batch:
        timeout: 10s
        send_batch_size: 1024

    exporters:
      elasticsearch:
        endpoints: [http://elasticsearch:9200]
        traces_index: otel-traces
        logs_index: otel-logs
        metrics_index: otel-metrics
      
      logging:
        loglevel: debug

    service:
      pipelines:
        traces:
          receivers: [otlp]
          processors: [batch]
          exporters: [elasticsearch, logging]
        
        metrics:
          receivers: [otlp]
          processors: [batch]
          exporters: [elasticsearch, logging]
        
        logs:
          receivers: [otlp]
          processors: [batch]
          exporters: [elasticsearch, logging]
    EOF
  
  # ============================================
  # Crear docker-compose.yaml para OTel Collector
  # ============================================
  - |
    cat > /home/${admin_username}/otel-stack/docker-compose-collector.yaml <<'EOF'
    version: '3.8'

    services:
      otel-collector:
        image: otel/opentelemetry-collector-contrib:latest
        container_name: otel-collector
        command: ["--config=/etc/otel-collector-config.yaml"]
        volumes:
          - ./otel-collector-config/otel-collector-config.yaml:/etc/otel-collector-config.yaml
        ports:
          - "4317:4317"   # gRPC
          - "4318:4318"   # HTTP
        networks:
          - otel-network
        restart: unless-stopped

    networks:
      otel-network:
        driver: bridge
    EOF
  
  # ============================================
  # Crear docker-compose.yaml para Elasticsearch + Kibana
  # ============================================
  - |
    cat > /home/${admin_username}/otel-stack/docker-compose-elastic.yaml <<'EOF'
    version: '3.8'

    services:
      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
        container_name: elasticsearch
        environment:
          - discovery.type=single-node
          - xpack.security.enabled=false
          - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
        volumes:
          - ./elasticsearch-data:/usr/share/elasticsearch/data
        ports:
          - "9200:9200"
          - "9300:9300"
        networks:
          - otel-network
        restart: unless-stopped
        healthcheck:
          test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
          interval: 30s
          timeout: 10s
          retries: 5

      kibana:
        image: docker.elastic.co/kibana/kibana:8.11.0
        container_name: kibana
        environment:
          - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
        ports:
          - "5601:5601"
        networks:
          - otel-network
        depends_on:
          elasticsearch:
            condition: service_healthy
        restart: unless-stopped

    networks:
      otel-network:
        driver: bridge
    EOF
  
  # ============================================
  # Crear script de inicio
  # ============================================
  - |
    cat > /home/${admin_username}/otel-stack/start-all.sh <<'EOF'
    #!/bin/bash
    echo "üöÄ Iniciando stack de observabilidad..."
    
    # Iniciar Elasticsearch y Kibana
    echo "üìä Iniciando Elasticsearch y Kibana..."
    docker compose -f docker-compose-elastic.yaml up -d
    
    # Esperar a que Elasticsearch est√© listo
    echo "‚è≥ Esperando a que Elasticsearch est√© listo..."
    sleep 30
    
    # Iniciar OTel Collector
    echo "üì° Iniciando OTel Collector..."
    docker compose -f docker-compose-collector.yaml up -d
    
    echo "‚úÖ Stack iniciado correctamente!"
    echo ""
    echo "Servicios disponibles:"
    echo "  - OTel Collector (gRPC): 4317"
    echo "  - OTel Collector (HTTP): 4318"
    echo "  - Elasticsearch: 9200"
    echo "  - Kibana: 5601"
    echo ""
    echo "Ver logs:"
    echo "  docker compose -f docker-compose-elastic.yaml logs -f"
    echo "  docker compose -f docker-compose-collector.yaml logs -f"
    EOF
  
  - chmod +x /home/${admin_username}/otel-stack/start-all.sh
  
  # ============================================
  # Crear script de detenci√≥n
  # ============================================
  - |
    cat > /home/${admin_username}/otel-stack/stop-all.sh <<'EOF'
    #!/bin/bash
    echo "üõë Deteniendo stack de observabilidad..."
    docker compose -f docker-compose-collector.yaml down
    docker compose -f docker-compose-elastic.yaml down
    echo "‚úÖ Stack detenido"
    EOF
  
  - chmod +x /home/${admin_username}/otel-stack/stop-all.sh
  
  # ============================================
  # Crear acceso directo de Kibana en el escritorio
  # ============================================
  - |
    cat > /usr/share/applications/kibana.desktop <<EOF
    [Desktop Entry]
    Name=Kibana Dashboard
    GenericName=Observability Dashboard
    Comment=Open Kibana in Firefox
    Exec=firefox http://localhost:5601
    Terminal=false
    Type=Application
    Icon=firefox
    Categories=Development;Network;
    EOF
  
  # Copiar acceso directo al escritorio del usuario
  - mkdir -p /home/${admin_username}/Desktop
  - cp /usr/share/applications/kibana.desktop /home/${admin_username}/Desktop/
  - chmod +x /home/${admin_username}/Desktop/kibana.desktop
  
  # ============================================
  # Crear acceso directo para Docker Logs
  # ============================================
  - |
    cat > /home/${admin_username}/Desktop/docker-logs.desktop <<EOF
    [Desktop Entry]
    Name=Docker Logs
    GenericName=View Docker Logs
    Comment=Open terminal with docker logs
    Exec=xfce4-terminal -e "bash -c 'cd ~/otel-stack && docker compose -f docker-compose-elastic.yaml logs -f; exec bash'"
    Terminal=false
    Type=Application
    Icon=utilities-terminal
    Categories=System;
    EOF
  
  - chmod +x /home/${admin_username}/Desktop/docker-logs.desktop
  
  # ============================================
  # Ajustar permisos
  # ============================================
  - chown -R ${admin_username}:${admin_username} /home/${admin_username}/otel-stack
  - chown -R ${admin_username}:${admin_username} /home/${admin_username}/Desktop
  - chmod -R 755 /home/${admin_username}/otel-stack
  
  # ============================================
  # Crear archivo README en el escritorio
  # ============================================
  - |
    cat > /home/${admin_username}/Desktop/README.txt <<EOF
    ========================================
    VM Observability Stack - Informaci√≥n
    ========================================
    
    üñ•Ô∏è  ESCRITORIO REMOTO (RDP):
       Puerto: 3389
       Usuario: ${admin_username}
       Contrase√±a: (la que configuraste)
    
    üìÅ Directorio principal: ~/otel-stack
    
    üöÄ Iniciar todo el stack:
       cd ~/otel-stack
       ./start-all.sh
    
    üõë Detener todo el stack:
       cd ~/otel-stack
       ./stop-all.sh
    
    üìä Servicios disponibles:
       - OTel Collector (gRPC): puerto 4317
       - OTel Collector (HTTP): puerto 4318
       - Elasticsearch: puerto 9200
       - Kibana: puerto 5601
    
    üîç Ver logs:
       docker compose -f docker-compose-elastic.yaml logs -f
       docker compose -f docker-compose-collector.yaml logs -f
    
    üåê Acceder a Kibana:
       - Desde el escritorio: doble click en "Kibana Dashboard"
       - Desde navegador: http://localhost:5601
       - Desde fuera: http://<IP_PUBLICA>:5601
    
    üì° Endpoint para App Services (interno):
       gRPC: http://<IP_PRIVADA>:4317
    
    üê≥ Comandos √∫tiles de Docker:
       docker ps                    # Ver contenedores
       docker compose ps            # Ver servicios
       docker logs <container>      # Ver logs de un contenedor
       docker stats                 # Ver uso de recursos
    
    ========================================
    EOF
  
  - chown ${admin_username}:${admin_username} /home/${admin_username}/Desktop/README.txt
  
  # ============================================
  # Iniciar el stack autom√°ticamente
  # ============================================
  - cd /home/${admin_username}/otel-stack && sudo -u ${admin_username} ./start-all.sh

final_message: "VM Observability Stack con Escritorio XFCE lista! Docker, OTel Collector, Elasticsearch, Kibana y RDP configurados."
