#cloud-config

# Script de inicialización para VM Linux con:
# - Entorno de escritorio XFCE
# - XRDP para acceso remoto
# - Java (OpenJDK 17)
# - Maven
# - Postman

package_update: true
package_upgrade: true

packages:
  - xfce4
  - xfce4-goodies
  - xrdp
  - firefox
  - git
  - curl
  - wget
  - vim
  - openjdk-17-jdk
  - maven
  - unzip

runcmd:
  # Configurar XRDP para usar XFCE
  - echo "xfce4-session" > /home/${admin_username}/.xsession
  - chown ${admin_username}:${admin_username} /home/${admin_username}/.xsession
  
  # Configurar XRDP
  - sed -i 's/3389/3389/g' /etc/xrdp/xrdp.ini
  - sed -i 's/max_bpp=32/max_bpp=128/g' /etc/xrdp/xrdp.ini
  - sed -i 's/xserverbpp=24/xserverbpp=128/g' /etc/xrdp/xrdp.ini
  - echo "startxfce4" > /etc/xrdp/startwm.sh
  
  # Reiniciar servicio XRDP
  - systemctl enable xrdp
  - systemctl restart xrdp
  
  # Descargar e instalar Postman
  - cd /tmp
  - wget https://dl.pstmn.io/download/latest/linux64 -O postman-linux-x64.tar.gz
  - tar -xzf postman-linux-x64.tar.gz -C /opt
  - ln -s /opt/Postman/Postman /usr/local/bin/postman
  
  # Crear acceso directo de Postman para el escritorio
  - |
    cat > /usr/share/applications/postman.desktop <<EOF
    [Desktop Entry]
    Name=Postman
    GenericName=API Client
    Comment=Test and develop APIs
    Exec=/opt/Postman/Postman
    Terminal=false
    Type=Application
    Icon=/opt/Postman/app/resources/app/assets/icon.png
    Categories=Development;
    EOF
  
  # Configurar variables de entorno de Java y Maven
  - echo 'export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64' >> /etc/profile.d/java.sh
  - echo 'export PATH=$PATH:$JAVA_HOME/bin' >> /etc/profile.d/java.sh
  - echo 'export M2_HOME=/usr/share/maven' >> /etc/profile.d/maven.sh
  - echo 'export PATH=$PATH:$M2_HOME/bin' >> /etc/profile.d/maven.sh
  
  # Crear directorio de trabajo para proyectos
  - mkdir -p /home/${admin_username}/projects
  - chown -R ${admin_username}:${admin_username} /home/${admin_username}/projects
  
  # Crear archivo de bienvenida con información
  - |
    cat > /home/${admin_username}/README.txt <<EOF
    ========================================
    VM Backend - Información de Acceso
    ========================================
    
    Conexión RDP:
    - Usuario: ${admin_username}
    - Puerto: 3389
    - Usa tu clave SSH o password configurado
    
    Software Instalado:
    ✅ Escritorio XFCE4
    ✅ Java (OpenJDK 17)
    ✅ Maven
    ✅ Postman
    ✅ Git
    ✅ Firefox
    
    Verificar instalaciones:
    - java -version
    - mvn -version
    - postman (desde terminal o menú de aplicaciones)
    
    Directorio de trabajo: ~/projects
    
    ========================================
    EOF
  
  - chown ${admin_username}:${admin_username} /home/${admin_username}/README.txt

final_message: "VM Backend lista! Escritorio XFCE, Java, Maven y Postman instalados correctamente."
